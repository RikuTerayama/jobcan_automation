<!doctype html>
<html lang="ja" class="no-js">
<head>
    {% set page_title = 'è­°äº‹éŒ²æ•´å½¢ãƒ„ãƒ¼ãƒ« - æ±ºå®šäº‹é …ãƒ»ToDoæŠ½å‡ºãƒ»CSV/JSONå‡ºåŠ› | ãƒ–ãƒ©ã‚¦ã‚¶å†…å‡¦ç†ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸è¦' %}
    {% set page_description = 'è­°äº‹éŒ²ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ±ºå®šäº‹é …ãƒ»ToDoãƒ»æ‹…å½“ãƒ»æœŸé™ã‚’è‡ªå‹•æŠ½å‡ºã—ã€å ±å‘Šæ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆã€‚CSV/JSONå‡ºåŠ›å¯¾å¿œã€‚ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‡¦ç†ã•ã‚Œã€ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã›ã‚“ã€‚' %}
    {% set breadcrumb_title = product.name|default('è­°äº‹éŒ²æ•´å½¢') %}
    {% include 'includes/head_meta.html' %}
    {% block description_meta %}
        <meta name="description" content="{% if page_description|length > 110 %}{{ page_description[:107] }}...{% else %}{{ page_description }}{% endif %}">
    {% endblock %}
    {# P1-4: SoftwareApplicationæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ #}
    {% if product %}
    {% include 'includes/structured_data.html' %}
    {% block extra_structured_data %}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "{{ product.name|e }}",
        "description": "{{ product.description|e }}",
        "url": "https://jobcan-automation.onrender.com{{ product.path }}",
        "applicationCategory": "WebApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "JPY"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Jobcan AutoFill",
            "url": "https://jobcan-automation.onrender.com"
        }
    }
    </script>
    {% endblock %}
    {% endif %}
    {% block og_description %}
        <meta property="og:description" content="{% if page_description|length > 200 %}{{ page_description[:197] }}...{% else %}{{ page_description }}{% endif %}">
    {% endblock %}
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Noto Sans JP', 'Helvetica Neue', 'Segoe UI', sans-serif;
        }
        
        body {
            font-family: 'Noto Sans JP', 'Helvetica Neue', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #121212 0%, #1A1A1A 50%, #0F0F0F 100%);
            min-height: 100vh;
            color: #FFFFFF;
            letter-spacing: 0.05em;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .page-header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 40px;
        }
        
        .page-header h1 {
            font-size: 2.5em;
            margin: 0 0 15px 0;
            color: #FFFFFF;
            font-weight: 600;
        }
        
        .page-header p {
            font-size: 1.1em;
            color: rgba(255, 255, 255, 0.8);
            max-width: 700px;
            margin: 0 auto;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: rgba(30, 30, 30, 0.5);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel h3 {
            color: #4A9EFF;
            font-size: 1.2em;
            margin: 0 0 20px 0;
        }
        
        .option-group {
            margin-bottom: 15px;
        }
        
        .option-group label {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .option-group input,
        .option-group select,
        .option-group textarea {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #FFFFFF;
            font-size: 0.95em;
            font-family: inherit;
        }
        
        .option-group textarea {
            min-height: 200px;
            resize: vertical;
        }
        
        .option-group input[type="file"] {
            padding: 8px;
        }
        
        .action-button {
            padding: 12px 24px;
            background: rgba(74, 158, 255, 0.2);
            border: 1px solid rgba(74, 158, 255, 0.5);
            border-radius: 8px;
            color: #4A9EFF;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .action-button:hover:not(:disabled) {
            background: rgba(74, 158, 255, 0.3);
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-button.secondary {
            background: rgba(255, 152, 0, 0.2);
            border-color: rgba(255, 152, 0, 0.5);
            color: #FF9800;
        }
        
        .action-button.secondary:hover:not(:disabled) {
            background: rgba(255, 152, 0, 0.3);
        }
        
        .item-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .item-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .item-card input {
            width: 100%;
            margin-bottom: 8px;
        }
        
        .item-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .item-card-actions button {
            padding: 6px 12px;
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            border-radius: 6px;
            color: #F44336;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .item-card-actions button:hover {
            background: rgba(244, 67, 54, 0.3);
        }
        
        .output-preview {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
        }
        
        .output-actions {
            display: flex;
            gap: 10px;
        }
        
        .output-actions button {
            flex: 1;
        }
        
        .info-text {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    {% include 'includes/header.html' %}
    {% include 'includes/breadcrumb.html' %}
    
    <div class="container">
        <div class="page-header">
            <h1 data-reveal>ğŸ“ è­°äº‹éŒ²æ•´å½¢</h1>
            <p data-reveal data-reveal-delay="50">è¦ç´„ã§ã¯ãªãæˆæœç‰©ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¸æ•´å½¢ã—ã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ã§ã€ãƒ†ã‚­ã‚¹ãƒˆã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã›ã‚“ã€‚</p>
            <a href="/guide/minutes" style="display: inline-block; margin-top: 15px; padding: 10px 20px; background: rgba(74, 158, 255, 0.2); border: 1px solid rgba(74, 158, 255, 0.5); border-radius: 8px; color: #4A9EFF; text-decoration: none; font-weight: 500; transition: all 0.3s;" data-reveal data-reveal-delay="100">ğŸ“š ã‚¬ã‚¤ãƒ‰ã‚’èª­ã‚€</a>
        </div>
        
        {# P0-2: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç›®çš„ã®æ˜ç¢ºåŒ–ãƒ–ãƒ­ãƒƒã‚¯ #}
        {% include 'includes/tool_content_blocks.html' %}
        
        <div class="main-layout">
            <!-- å·¦: å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="panel">
                <h3>ğŸ“¥ å…¥åŠ›</h3>
                
                <div class="option-group">
                    <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
                    <select id="template-select" onchange="updateTemplateOptions()">
                        <option value="action">æ±ºå®šäº‹é …ã¨ToDoåˆ†è§£</option>
                        <option value="report">ä¸Šå¸å‘ã‘å ±å‘Šæ›¸</option>
                        <option value="incident">ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç”¨</option>
                    </select>
                </div>
                
                <div id="meta-common" class="option-group">
                    <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="meta-title" placeholder="ä¼šè­°ã‚¿ã‚¤ãƒˆãƒ«">
                </div>
                
                <div id="meta-common" class="option-group">
                    <label>æ—¥ä»˜</label>
                    <input type="text" id="meta-date" placeholder="YYYY-MM-DD">
                </div>
                
                <div id="meta-common" class="option-group">
                    <label>å‚åŠ è€…</label>
                    <input type="text" id="meta-participants" placeholder="å‚åŠ è€…åï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰">
                </div>
                
                <div id="meta-common" class="option-group">
                    <label>ä½œæˆè€…</label>
                    <input type="text" id="meta-author" placeholder="ä½œæˆè€…å">
                </div>
                
                <div id="meta-incident" class="option-group" style="display: none;">
                    <label>é‡è¦åº¦</label>
                    <input type="text" id="meta-severity" placeholder="Critical / High / Medium / Low">
                </div>
                
                <div id="meta-incident" class="option-group" style="display: none;">
                    <label>å½±éŸ¿ã‚·ã‚¹ãƒ†ãƒ </label>
                    <input type="text" id="meta-systems" placeholder="å½±éŸ¿ã‚’å—ã‘ãŸã‚·ã‚¹ãƒ†ãƒ ">
                </div>
                
                <div class="option-group">
                    <label>åŸæ–‡ï¼ˆè²¼ã‚Šä»˜ã‘ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼‰</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="file" id="file-input" accept="text/plain" style="flex: 1;">
                        <button class="action-button secondary" onclick="loadSampleText()" style="flex: 0 0 auto; padding: 10px 15px;">ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›</button>
                    </div>
                    <textarea id="raw-text" placeholder="è­°äº‹éŒ²ã®åŸæ–‡ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
                    <p class="info-text">æœ€å¤§200,000æ–‡å­—ã¾ã§</p>
                </div>
                
                <button id="extract-button" class="action-button" onclick="extractAndFormat()">æŠ½å‡ºã—ã¦æ•´å½¢</button>
            </div>
            
            <!-- ä¸­å¤®: ç·¨é›†ã‚¨ãƒªã‚¢ -->
            <div class="panel">
                <h3>âœï¸ ç·¨é›†</h3>
                
                <div class="option-group">
                    <label>æ±ºå®šäº‹é …</label>
                    <div id="decisions-list" class="item-list"></div>
                    <button class="action-button secondary" onclick="addDecision()">æ±ºå®šäº‹é …ã‚’è¿½åŠ </button>
                </div>
                
                <div class="option-group">
                    <label>ToDoï¼ˆv2: ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ä¸¦ã³æ›¿ãˆï¼‰</label>
                    <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="filter-open-only" onchange="updateActionsDisplay()">
                            <span>æœªå®Œäº†ã®ã¿</span>
                        </label>
                        <select id="filter-owner" onchange="updateActionsDisplay()" style="flex: 1; min-width: 120px;">
                            <option value="">æ‹…å½“ã§çµã‚Šè¾¼ã¿</option>
                        </select>
                        <select id="sort-actions" onchange="updateActionsDisplay()" style="flex: 1; min-width: 120px;">
                            <option value="source">å…ƒã®é †åº</option>
                            <option value="due">æœŸé™é †</option>
                            <option value="owner">æ‹…å½“é †</option>
                        </select>
                    </div>
                    <div id="actions-list" class="item-list"></div>
                    <button class="action-button secondary" onclick="addAction()">ToDoã‚’è¿½åŠ </button>
                </div>
                
                <button class="action-button secondary" onclick="reExtract()">åŸæ–‡ã‹ã‚‰å†æŠ½å‡ºï¼ˆç·¨é›†å†…å®¹ã‚’ä¸Šæ›¸ãï¼‰</button>
            </div>
            
            <!-- å³: å‡ºåŠ›ã‚¨ãƒªã‚¢ -->
            <div class="panel">
                <h3>ğŸ“¤ å‡ºåŠ›</h3>
                
                <div id="output-preview" class="output-preview" style="display: none;"></div>
                
                <div id="output-actions" class="output-actions" style="display: none;">
                    <button class="action-button" onclick="copyOutput()">Markdownã‚’ã‚³ãƒ”ãƒ¼</button>
                    <button class="action-button" onclick="downloadOutput()">Markdownã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <button class="action-button secondary" onclick="downloadActionsCsv()">ToDo CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <button class="action-button secondary" onclick="downloadActionsJson()">ToDo JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>
        </div>
    </div>

    {% include 'includes/related_tools.html' %}
    {% include 'includes/footer.html' %}
    
    <!-- å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="{{ url_for('static', filename='js/file-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/file-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/minutes-parse.js') }}"></script>
    <script src="{{ url_for('static', filename='js/minutes-normalize.js') }}"></script>
    <script src="{{ url_for('static', filename='js/minutes-date.js') }}"></script>
    <script src="{{ url_for('static', filename='js/minutes-extract.js') }}"></script>
    <script src="{{ url_for('static', filename='js/minutes-templates.js') }}"></script>
    <script src="{{ url_for('static', filename='js/minutes-export.js') }}"></script>
    <script src="{{ url_for('static', filename='js/minutes-export-v2.js') }}"></script>
    
    <script>
        let state = {
            templateId: 'action',
            rawText: '',
            meta: {
                title: '',
                date: '',
                participants: '',
                author: ''
            },
            incidentMeta: {
                title: '',
                date: '',
                severity: '',
                systems: ''
            },
            decisions: [],
            actions: [],
            outputMarkdown: ''
        };
        
        const MAX_TEXT_LENGTH = 200000;
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setupFileInput();
        });
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®è¨­å®š
        function setupFileInput() {
            const fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.size > MAX_TEXT_LENGTH) {
                    alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§${MAX_TEXT_LENGTH}æ–‡å­—ï¼‰`);
                    return;
                }
                
                try {
                    const text = await file.text();
                    if (text.length > MAX_TEXT_LENGTH) {
                        alert(`ãƒ†ã‚­ã‚¹ãƒˆãŒé•·ã™ãã¾ã™ï¼ˆæœ€å¤§${MAX_TEXT_LENGTH}æ–‡å­—ï¼‰ã€‚å…ˆé ­ã‹ã‚‰å‡¦ç†ã—ã¾ã™ã€‚`);
                        document.getElementById('raw-text').value = text.substring(0, MAX_TEXT_LENGTH);
                    } else {
                        document.getElementById('raw-text').value = text;
                    }
                } catch (error) {
                    alert(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            });
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateTemplateOptions() {
            const templateId = document.getElementById('template-select').value;
            state.templateId = templateId;
            
            const metaCommon = document.querySelectorAll('#meta-common');
            const metaIncident = document.querySelectorAll('#meta-incident');
            
            if (templateId === 'incident') {
                metaCommon.forEach(el => el.style.display = 'none');
                metaIncident.forEach(el => el.style.display = 'block');
            } else {
                metaCommon.forEach(el => el.style.display = 'block');
                metaIncident.forEach(el => el.style.display = 'none');
            }
            
            regenerateOutput();
        }
        
        // æŠ½å‡ºã—ã¦æ•´å½¢
        function extractAndFormat() {
            const rawText = document.getElementById('raw-text').value.trim();
            
            if (!rawText) {
                alert('åŸæ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (rawText.length > MAX_TEXT_LENGTH) {
                alert(`ãƒ†ã‚­ã‚¹ãƒˆãŒé•·ã™ãã¾ã™ï¼ˆæœ€å¤§${MAX_TEXT_LENGTH}æ–‡å­—ï¼‰ã€‚å…ˆé ­ã‹ã‚‰å‡¦ç†ã—ã¾ã™ã€‚`);
                state.rawText = rawText.substring(0, MAX_TEXT_LENGTH);
            } else {
                state.rawText = rawText;
            }
            
            // ãƒ¡ã‚¿æƒ…å ±ã‚’å–å¾—
            state.meta = {
                title: document.getElementById('meta-title').value.trim(),
                date: document.getElementById('meta-date').value.trim(),
                participants: document.getElementById('meta-participants').value.trim(),
                author: document.getElementById('meta-author').value.trim()
            };
            
            if (state.templateId === 'incident') {
                state.incidentMeta = {
                    title: document.getElementById('meta-title').value.trim() || state.incidentMeta.title,
                    date: document.getElementById('meta-date').value.trim() || state.incidentMeta.date,
                    severity: document.getElementById('meta-severity').value.trim(),
                    systems: document.getElementById('meta-systems').value.trim()
                };
            }
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ­£è¦åŒ–ã—ã¦è¡Œã«åˆ†å‰²
            const normalized = MinutesParse.normalizeText(state.rawText);
            const lines = MinutesParse.splitLines(normalized);
            
            // v2: æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ï¼ˆconfidenceã€acceptedã€sourceså¯¾å¿œï¼‰
            const baseDate = state.meta.date || null;
            const { decisions, actions } = MinutesExtract.extractCandidates(lines, baseDate);
            
            state.decisions = decisions;
            state.actions = actions;
            
            // UIã‚’æ›´æ–°
            renderEditPanels();
            regenerateOutput();
        }
        
        // å†æŠ½å‡º
        function reExtract() {
            if (!confirm('ç·¨é›†å†…å®¹ã‚’ä¸Šæ›¸ãã—ã¦å†æŠ½å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            extractAndFormat();
        }
        
        // ç·¨é›†ãƒ‘ãƒãƒ«ã‚’æç”»
        function renderEditPanels() {
            renderDecisions();
            renderActions();
        }
        
        // æ±ºå®šäº‹é …ã‚’æç”»
        function renderDecisions() {
            const container = document.getElementById('decisions-list');
            container.innerHTML = '';
            
            state.decisions.forEach((dec, index) => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <input type="text" value="${dec.text}" 
                           onchange="updateDecision(${index}, this.value)"
                           placeholder="æ±ºå®šäº‹é …">
                    <div class="item-card-actions">
                        <button onclick="removeDecision(${index})">å‰Šé™¤</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // ToDoã‚’æç”»ï¼ˆv2: ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ä¸¦ã³æ›¿ãˆå¯¾å¿œï¼‰
        function renderActions() {
            updateActionsDisplay();
        }
        
        function updateActionsDisplay() {
            const container = document.getElementById('actions-list');
            container.innerHTML = '';
            
            // ãƒ•ã‚£ãƒ«ã‚¿ã¨ä¸¦ã³æ›¿ãˆã‚’é©ç”¨
            let filtered = [...state.actions];
            
            // æœªå®Œäº†ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
            const filterOpenOnly = document.getElementById('filter-open-only');
            if (filterOpenOnly && filterOpenOnly.checked) {
                filtered = filtered.filter(action => action.status !== 'done');
            }
            
            // æ‹…å½“ã§ãƒ•ã‚£ãƒ«ã‚¿
            const filterOwner = document.getElementById('filter-owner');
            if (filterOwner && filterOwner.value) {
                filtered = filtered.filter(action => action.owner === filterOwner.value);
            }
            
            // ä¸¦ã³æ›¿ãˆ
            const sortBy = document.getElementById('sort-actions');
            if (sortBy) {
                if (sortBy.value === 'due') {
                    filtered.sort((a, b) => {
                        const aDue = a.dueNormalized || a.dueRaw || '';
                        const bDue = b.dueNormalized || b.dueRaw || '';
                        if (aDue && bDue) return aDue.localeCompare(bDue);
                        if (aDue) return -1;
                        if (bDue) return 1;
                        return 0;
                    });
                } else if (sortBy.value === 'owner') {
                    filtered.sort((a, b) => {
                        const aOwner = a.owner || '';
                        const bOwner = b.owner || '';
                        return aOwner.localeCompare(bOwner);
                    });
                }
            }
            
            // æ‹…å½“ãƒ•ã‚£ãƒ«ã‚¿ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
            updateOwnerFilterOptions();
            
            // æç”»
            filtered.forEach((action) => {
                const originalIndex = state.actions.findIndex(a => a.id === action.id);
                const card = document.createElement('div');
                card.className = 'item-card';
                
                // v2: confidenceã¨acceptedã‚’è¡¨ç¤º
                const confidenceBadge = action.confidence !== undefined 
                    ? `<span style="font-size: 0.8em; color: ${action.confidence >= 60 ? '#4CAF50' : '#FF9800'};">
                        ä¿¡é ¼åº¦: ${action.confidence}%
                       </span>`
                    : '';
                const acceptedCheck = `<input type="checkbox" ${action.accepted !== false ? 'checked' : ''} 
                                       onchange="toggleActionAccepted(${originalIndex}, this.checked)"
                                       style="width: auto; margin-right: 5px;">
                                      <label style="margin: 0; font-size: 0.9em;">å‡ºåŠ›ã«å«ã‚ã‚‹</label>`;
                
                const title = (action.title || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const owner = (action.owner || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const dueRaw = (action.dueRaw || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const dueNormalized = (action.dueNormalized || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        ${acceptedCheck}
                        ${confidenceBadge}
                    </div>
                    <input type="text" value="${title}" 
                           onchange="updateAction(${originalIndex}, 'title', this.value)"
                           placeholder="ã‚¿ã‚¹ã‚¯">
                    <input type="text" value="${owner}" 
                           onchange="updateAction(${originalIndex}, 'owner', this.value)"
                           placeholder="æ‹…å½“">
                    <div style="display: flex; gap: 5px;">
                        <input type="text" value="${dueRaw}" 
                               onchange="updateAction(${originalIndex}, 'dueRaw', this.value); normalizeActionDue(${originalIndex})"
                               placeholder="æœŸé™ï¼ˆåŸæ–‡ï¼‰" style="flex: 1;">
                        <input type="text" value="${dueNormalized}" 
                               readonly
                               placeholder="æœŸé™ï¼ˆæ­£è¦åŒ–ï¼‰" style="flex: 1; background: rgba(0, 0, 0, 0.2);">
                    </div>
                    <div class="item-card-actions">
                        <label style="color: rgba(255, 255, 255, 0.8); font-size: 0.9em;">
                            <input type="checkbox" ${action.status === 'done' ? 'checked' : ''} 
                                   onchange="updateAction(${originalIndex}, 'status', this.checked ? 'done' : 'open')"
                                   style="width: auto; margin-right: 5px;">
                            å®Œäº†
                        </label>
                        <button onclick="removeAction(${originalIndex})">å‰Šé™¤</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function updateOwnerFilterOptions() {
            const select = document.getElementById('filter-owner');
            if (!select) return;
            
            const currentValue = select.value;
            const owners = [...new Set(state.actions.map(a => a.owner).filter(o => o))].sort();
            
            select.innerHTML = '<option value="">æ‹…å½“ã§çµã‚Šè¾¼ã¿</option>';
            owners.forEach(owner => {
                const option = document.createElement('option');
                option.value = owner;
                option.textContent = owner;
                if (owner === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
        function toggleActionAccepted(index, accepted) {
            if (state.actions[index]) {
                state.actions[index].accepted = accepted;
                regenerateOutput();
            }
        }
        
        function normalizeActionDue(index) {
            if (state.actions[index] && state.actions[index].dueRaw) {
                const baseDate = state.meta.date || null;
                state.actions[index].dueNormalized = MinutesDate.normalizeDueDate(
                    state.actions[index].dueRaw,
                    baseDate
                );
                updateActionsDisplay();
                regenerateOutput();
            }
        }
        
        // æ±ºå®šäº‹é …ã‚’æ›´æ–°
        function updateDecision(index, text) {
            if (state.decisions[index]) {
                state.decisions[index].text = text;
                regenerateOutput();
            }
        }
        
        // ToDoã‚’æ›´æ–°
        function updateAction(index, field, value) {
            if (state.actions[index]) {
                state.actions[index][field] = value;
                regenerateOutput();
            }
        }
        
        // æ±ºå®šäº‹é …ã‚’è¿½åŠ 
        function addDecision() {
            state.decisions.push({
                id: `dec_${Date.now()}`,
                text: '',
                sourceLine: undefined
            });
            renderDecisions();
        }
        
        // ToDoã‚’è¿½åŠ 
        function addAction() {
            state.actions.push({
                id: `action_${Date.now()}`,
                title: '',
                owner: '',
                dueRaw: '',
                dueNormalized: '',
                status: 'open',
                confidence: 50,
                accepted: true,
                sources: []
            });
            renderActions();
        }
        
        // æ±ºå®šäº‹é …ã‚’å‰Šé™¤
        function removeDecision(index) {
            state.decisions.splice(index, 1);
            renderDecisions();
            regenerateOutput();
        }
        
        // ToDoã‚’å‰Šé™¤
        function removeAction(index) {
            state.actions.splice(index, 1);
            renderActions();
            regenerateOutput();
        }
        
        // å‡ºåŠ›ã‚’å†ç”Ÿæˆ
        function regenerateOutput() {
            let md = '';
            
            if (state.templateId === 'action') {
                md = MinutesTemplates.renderActionTemplate(
                    state.meta,
                    state.decisions,
                    state.actions,
                    state.rawText
                );
            } else if (state.templateId === 'report') {
                md = MinutesTemplates.renderReportTemplate(
                    state.meta,
                    state.decisions,
                    state.actions,
                    state.rawText,
                    {}
                );
            } else if (state.templateId === 'incident') {
                md = MinutesTemplates.renderIncidentTemplate(
                    state.incidentMeta,
                    state.decisions,
                    state.actions,
                    state.rawText,
                    {}
                );
            }
            
            state.outputMarkdown = md;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            const preview = document.getElementById('output-preview');
            const actions = document.getElementById('output-actions');
            
            if (md) {
                preview.textContent = md;
                preview.style.display = 'block';
                actions.style.display = 'flex';
            } else {
                preview.style.display = 'none';
                actions.style.display = 'none';
            }
        }
        
        // å‡ºåŠ›ã‚’ã‚³ãƒ”ãƒ¼
        async function copyOutput() {
            if (!state.outputMarkdown) return;
            
            const success = await MinutesExport.copyToClipboard(state.outputMarkdown);
            if (success) {
                MinutesExport.showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            } else {
                MinutesExport.showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // å‡ºåŠ›ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadOutput() {
            if (!state.outputMarkdown) return;
            
            const filenameBase = state.meta.title || 
                                (state.templateId === 'incident' ? state.incidentMeta.title : '') ||
                                'minutes';
            MinutesExport.downloadMarkdown(state.outputMarkdown, filenameBase);
        }
        
        // v2: ToDo CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadActionsCsv() {
            const acceptedActions = state.actions.filter(action => action.accepted !== false);
            if (acceptedActions.length === 0) {
                alert('å‡ºåŠ›ã«å«ã‚ã‚‹ToDoãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const csv = MinutesExportV2.buildActionsCsv(acceptedActions);
            const filenameBase = state.meta.title || 'actions';
            MinutesExportV2.downloadCsv(csv, filenameBase);
        }
        
        // v2: ToDo JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadActionsJson() {
            const acceptedActions = state.actions.filter(action => action.accepted !== false);
            if (acceptedActions.length === 0) {
                alert('å‡ºåŠ›ã«å«ã‚ã‚‹ToDoãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const json = MinutesExportV2.buildActionsJson(acceptedActions);
            const filenameBase = state.meta.title || 'actions';
            MinutesExportV2.downloadJson(json, filenameBase);
        }
    </script>
</body>
</html>
