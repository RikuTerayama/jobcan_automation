<!doctype html>
<html lang="ja" class="no-js">
<head>
    {% set page_title = 'CSV/Excelãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ - æ–‡å­—ã‚³ãƒ¼ãƒ‰å¤‰æ›ãƒ»CSVâ‡„XLSXãƒ»é‡è¤‡å‰Šé™¤ãƒ»åˆ—æ“ä½œ | ãƒ–ãƒ©ã‚¦ã‚¶å†…å‡¦ç†ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸è¦' %}
    {% set page_description = 'CSVã®æ–‡å­—ã‚³ãƒ¼ãƒ‰å¤‰æ›ï¼ˆShift-JIS/UTF-8ï¼‰ã€CSVâ‡„XLSXå¤‰æ›ã€é‡è¤‡å‰Šé™¤ã€åˆ—ã®æŠ½å‡ºãƒ»ä¸¦ã¹æ›¿ãˆã€åˆ†å‰²ã€‚ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å®Ÿè¡Œã•ã‚Œã€ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã›ã‚“ã€‚' %}
    {% set breadcrumb_title = product.name|default('CSV/Excelãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£') %}
    {% include 'includes/head_meta.html' %}
    {% block description_meta %}
        <meta name="description" content="{% if page_description|length > 110 %}{{ page_description[:107] }}...{% else %}{{ page_description }}{% endif %}">
    {% endblock %}
    {% if product %}
    {% include 'includes/structured_data.html' %}
    {% block extra_structured_data %}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "{{ product.name|e }}",
        "description": "{{ product.description|e }}",
        "url": "https://jobcan-automation.onrender.com{{ product.path }}",
        "applicationCategory": "WebApplication",
        "operatingSystem": "Web Browser",
        "offers": { "@type": "Offer", "price": "0", "priceCurrency": "JPY" },
        "publisher": { "@type": "Organization", "name": "Jobcan AutoFill", "url": "https://jobcan-automation.onrender.com" }
    }
    </script>
    {% endblock %}
    {% endif %}
    {% block og_description %}
        <meta property="og:description" content="{% if page_description|length > 200 %}{{ page_description[:197] }}...{% else %}{{ page_description }}{% endif %}">
    {% endblock %}
    <style>
        * { box-sizing: border-box; font-family: 'Noto Sans JP', 'Helvetica Neue', 'Segoe UI', sans-serif; }
        body { margin: 0; padding: 0; background: linear-gradient(135deg, #121212 0%, #1A1A1A 50%, #0F0F0F 100%); min-height: 100vh; color: #FFFFFF; }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .page-header { text-align: center; padding: 40px 20px; margin-bottom: 40px; }
        .page-header h1 { font-size: 2.5em; margin: 0 0 15px 0; color: #FFFFFF; }
        .page-header p { font-size: 1.1em; color: rgba(255, 255, 255, 0.8); }
        .tool-section { background: rgba(30, 30, 30, 0.5); border-radius: 12px; padding: 30px; margin-bottom: 30px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .tool-section h3 { color: #4A9EFF; font-size: 1.3em; margin: 0 0 20px 0; }
    </style>
</head>
<body>
    {% include 'includes/header.html' %}
    {% include 'includes/breadcrumb.html' %}
    <div class="container">
        <div class="page-header">
            <h1 data-reveal>ğŸ“Š CSV/Excelãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£</h1>
            <p data-reveal data-reveal-delay="50">ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã›ãšã€ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å¤‰æ›ã—ã¾ã™ã€‚</p>
            {% include 'includes/tool_guide_link.html' %}
        </div>
        <div class="tool-section">
            <h3>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</h3>
            <p style="color: rgba(255, 255, 255, 0.8);">CSV ã¾ãŸã¯ Excel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã§é¸æŠã—ã¦ãã ã•ã„ã€‚ï¼ˆå¯¾å¿œ: .csv, .xlsxï¼‰</p>
            <div id="dropzone" style="border: 2px dashed rgba(74, 158, 255, 0.5); border-radius: 12px; padding: 40px 20px; text-align: center; background: rgba(74, 158, 255, 0.05); cursor: pointer;">
                <div style="font-size: 2.5em; margin-bottom: 15px;">ğŸ“</div>
                <p style="margin: 0; color: rgba(255, 255, 255, 0.9);">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                <input type="file" id="file-input" accept=".csv,.xlsx,.xls,text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" multiple style="display: none;">
            </div>
            <div id="file-list" style="margin-top: 15px;"></div>
            <div id="rejected-files" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255, 152, 0, 0.2); border-radius: 8px;"></div>
        </div>
        <div class="tool-section" id="options-section" style="display: none;">
            <h3>âš™ï¸ æ“ä½œ</h3>
            <label style="display: block; margin-bottom: 8px;">æ“ä½œãƒ¢ãƒ¼ãƒ‰</label>
            <select id="mode">
                <option value="column_extract">åˆ—ã®æŠ½å‡ºãƒ»ä¸¦ã¹æ›¿ãˆ</option>
                <option value="dedupe">é‡è¤‡å‰Šé™¤ï¼ˆã‚­ãƒ¼åˆ—æŒ‡å®šï¼‰</option>
                <option value="split">Nè¡Œã”ã¨åˆ†å‰²</option>
            </select>
            <div id="mode-options" style="margin-top: 15px;"></div>
            <button type="button" id="run-btn" style="margin-top: 20px; padding: 12px 24px; background: #4A9EFF; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">å®Ÿè¡Œ</button>
        </div>
        <div class="tool-section" id="preview-section" style="display: none;">
            <h3>ğŸ‘ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå…ˆé ­50è¡Œï¼‰</h3>
            <div id="preview-table-wrap" style="overflow: auto; max-height: 300px;"></div>
        </div>
        <div class="tool-section" id="output-section" style="display: none;">
            <h3>ğŸ“¤ çµæœ</h3>
            <div id="output-area"></div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/file-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/file-utils.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="{{ url_for('static', filename='js/zip-utils.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="{{ url_for('static', filename='js/csv-ops.js') }}"></script>
    <script>
(function() {
    const CSV_RULES = { maxFiles: 10, maxFileSize: 10 * 1024 * 1024, maxTotalSize: 50 * 1024 * 1024, allowedExtensions: ['.csv'] };
    let acceptedFiles = [];
    let parsedRows = null;
    let parsedMeta = null;

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    const rejectedEl = document.getElementById('rejected-files');
    const optionsSection = document.getElementById('options-section');
    const modeSelect = document.getElementById('mode');
    const modeOptions = document.getElementById('mode-options');
    const runBtn = document.getElementById('run-btn');
    const previewSection = document.getElementById('preview-section');
    const previewWrap = document.getElementById('preview-table-wrap');
    const outputSection = document.getElementById('output-section');
    const outputArea = document.getElementById('output-area');

    function showRejected(rejected) {
        if (!rejected.length) { rejectedEl.style.display = 'none'; return; }
        rejectedEl.style.display = 'block';
        rejectedEl.innerHTML = rejected.map(r => '<div class="rejected-file">' + (r.file.name || '') + ': ' + (r.reason || '') + '</div>').join('');
    }

    function renderFileList() {
        fileList.innerHTML = acceptedFiles.map((f, i) => '<div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;margin-bottom:6px;">' + (f.name || '') + ' (' + (f.size ? Math.round(f.size/1024) + ' KB' : '') + ')</div>').join('');
    }

    function buildModeOptions() {
        if (!parsedRows || !parsedRows.length) return;
        const header = parsedRows[0];
        const mode = modeSelect.value;
        modeOptions.innerHTML = '';
        if (mode === 'column_extract') {
            header.forEach((h, i) => {
                const label = document.createElement('label');
                label.style.display = 'block';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = true;
                cb.dataset.index = i;
                cb.style.marginRight = '8px';
                label.appendChild(cb);
                label.appendChild(document.createTextNode((i + 1) + ': ' + (h || 'åˆ—' + (i+1))));
                modeOptions.appendChild(label);
            });
        } else if (mode === 'dedupe') {
            const label = document.createElement('label');
            label.textContent = 'ã‚­ãƒ¼åˆ—: ';
            const sel = document.createElement('select');
            sel.id = 'dedupe-key';
            header.forEach((h, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = (h || 'åˆ—' + (i+1));
                sel.appendChild(opt);
            });
            label.appendChild(sel);
            modeOptions.appendChild(label);
        } else if (mode === 'split') {
            const label = document.createElement('label');
            label.textContent = 'Nè¡Œã”ã¨: ';
            const inp = document.createElement('input');
            inp.type = 'number';
            inp.id = 'split-n';
            inp.min = 1;
            inp.value = 1000;
            inp.style.width = '100px';
            label.appendChild(inp);
            modeOptions.appendChild(label);
        }
    }

    function renderPreview(rows) {
        if (!rows || !rows.length) return;
        const head = rows[0];
        const body = rows.slice(1, 51);
        let html = '<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;font-size:0.9em;background:rgba(0,0,0,0.2);">';
        html += '<thead><tr>' + head.map(h => '<th style="text-align:left;">' + (h != null ? String(h).replace(/</g,'&lt;') : '') + '</th>').join('') + '</tr></thead><tbody>';
        body.forEach(row => {
            html += '<tr>' + row.map(c => '<td>' + (c != null ? String(c).replace(/</g,'&lt;') : '') + '</td>').join('') + '</tr>';
        });
        html += '</tbody></table>';
        previewWrap.innerHTML = html;
        previewSection.style.display = 'block';
    }

    function setOutput(msg, isError) {
        outputSection.style.display = 'block';
        outputArea.innerHTML = '<p style="color:' + (isError ? '#f44' : 'rgba(255,255,255,0.9)') + ';">' + (msg || '').replace(/</g,'&lt;') + '</p>';
    }

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.style.background = 'rgba(74,158,255,0.15)'; });
    dropzone.addEventListener('dragleave', () => { dropzone.style.background = ''; });
    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.style.background = '';
        if (e.dataTransfer.files.length) fileInput.files = e.dataTransfer.files;
        fileInput.dispatchEvent(new Event('change'));
    });
    fileInput.addEventListener('change', () => {
        const files = Array.from(fileInput.files || []);
        const result = FileValidation.validateFiles(files, CSV_RULES);
        acceptedFiles = result.okFiles;
        showRejected(result.rejected);
        renderFileList();
        optionsSection.style.display = acceptedFiles.length ? 'block' : 'none';
        parsedRows = null;
        parsedMeta = null;
        previewSection.style.display = 'none';
        outputSection.style.display = 'none';
        if (acceptedFiles.length === 1) {
            CsvOps.readFileAsText(acceptedFiles[0]).then(text => {
                try {
                    const r = CsvOps.parseCSV(text, { preview: 50 });
                    parsedRows = r.data;
                    parsedMeta = r.meta;
                    renderPreview(parsedRows);
                    buildModeOptions();
                } catch (err) {
                    setOutput(err.message || 'CSVã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
                }
            }).catch(err => setOutput(err.message || 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true));
        } else if (acceptedFiles.length > 1) {
            setOutput('è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯å…ˆé ­1ä»¶ã®ã¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¾ã™ã€‚å®Ÿè¡Œæ™‚ã«1ä»¶ãšã¤å‡¦ç†ã—ã¾ã™ã€‚', false);
            CsvOps.readFileAsText(acceptedFiles[0]).then(text => {
                try {
                    const r = CsvOps.parseCSV(text, { preview: 50 });
                    parsedRows = r.data;
                    parsedMeta = r.meta;
                    renderPreview(parsedRows);
                    buildModeOptions();
                } catch (e) { buildModeOptions(); }
            }).catch(() => buildModeOptions());
        }
    });
    modeSelect.addEventListener('change', buildModeOptions);

    runBtn.addEventListener('click', () => {
        if (!acceptedFiles.length) { setOutput('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true); return; }
        outputSection.style.display = 'block';
        outputArea.innerHTML = '<p>å‡¦ç†ä¸­...</p>';
        const mode = modeSelect.value;
        const outputs = [];
        const processOne = (file, fileIndex) => {
            return CsvOps.readFileAsText(file).then(text => {
                const r = CsvOps.parseCSV(text);
                let rows = r.data;
                const base = FileUtils.getFilenameWithoutExtension(file.name) || 'output';
                if (mode === 'column_extract') {
                    const indexes = Array.from(modeOptions.querySelectorAll('input[type=checkbox]:checked')).map(cb => parseInt(cb.dataset.index, 10)).sort((a,b)=>a-b);
                    if (!indexes.length) throw new Error('1åˆ—ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
                    rows = CsvOps.selectColumns(rows, indexes);
                } else if (mode === 'dedupe') {
                    const keyCol = parseInt(document.getElementById('dedupe-key').value, 10);
                    rows = CsvOps.dedupeByKey(rows, keyCol);
                } else if (mode === 'split') {
                    const n = parseInt(document.getElementById('split-n').value, 10) || 1000;
                    if (n < 1) throw new Error('Nã¯1ä»¥ä¸Šã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
                    const chunks = CsvOps.splitByNRows(rows, n);
                    chunks.forEach((chunk, i) => {
                        const blob = CsvOps.rowsToBlob(chunk);
                        outputs.push({ blob, filename: CsvOps.outputFilename(base, 'part' + (i+1), 'csv') });
                    });
                    return;
                }
                const blob = CsvOps.rowsToBlob(rows);
                const suffix = mode === 'column_extract' ? 'columns' : mode === 'dedupe' ? 'dedupe' : 'split';
                outputs.push({ blob, filename: CsvOps.outputFilename(base, suffix, 'csv') });
            });
        };
        let chain = Promise.resolve();
        acceptedFiles.forEach((f, i) => { chain = chain.then(() => processOne(f, i)); });
        chain.then(() => {
            if (outputs.length === 0) { setOutput('å‡ºåŠ›ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', true); return; }
            if (outputs.length === 1) {
                FileUtils.downloadBlob(outputs[0].blob, outputs[0].filename);
                setOutput('1ä»¶ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ: ' + outputs[0].filename, false);
            } else {
                ZipUtils.createZip(outputs.map(o => ({ blob: o.blob, filename: o.filename })), 'csv_output.zip').then(zipBlob => {
                    FileUtils.downloadBlob(zipBlob, 'csv_output.zip');
                    setOutput(outputs.length + 'ä»¶ã‚’ZIPã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚', false);
                }).catch(err => setOutput(err.message || 'ZIPã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true));
            }
        }).catch(err => setOutput(err.message || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true));
    });
})();
    </script>
    {% include 'includes/footer.html' %}
</body>
</html>
