# Jobcan Automation 安定性向上計画

## 背景・症状

現在のシステムには以下の問題があります：

- **ログに Timeout 20000/30000ms exceeded**（ログアウト/ログイン/出勤簿遷移）
- **失敗直後に「✅ ログイン成功」など矛盾ログ**が出ている（例外を握りつぶして成功扱い）
- **Render 512MB 環境で不安定**。ユーザーの回線や表示の揺れに弱い

## 目標

1. **正しい成功判定**（特定セレクタ出現まで待つ／失敗は成功にしない）
2. **遷移の安定化**（待機60–90s、OR条件セレクタ、最大3回リトライ）
3. **障害時の材料**（スクショ/HTML/メモリログ保存）
4. **メモリ・同時実行の抑制**（画像/フォント等ブロック、直列実行、確実 close）

## 実装済みの改善

### 1. 共通ユーティリティ（`app/browser_utils.py`）

- **タイムアウト値の統一**: `NAV_TIMEOUT_MS=90000`, `STEP_TIMEOUT_MS=60000`
- **メモリ監視**: `guard_memory()`, `mem()` 関数
- **軽量化**: 重いアセット（画像、フォント、動画）のブロック
- **ナビゲーション再試行**: `navigate_with_retries()` で最大3回リトライ
- **確実クローズ**: `new_browser()` コンテキストマネージャー

### 2. 同時実行制御（`app/concurrency.py`）

- **セマフォ制御**: `browser_sem = asyncio.Semaphore(1)` で直列実行
- **環境変数対応**: `BROWSER_CONCURRENCY` で設定可能

### 3. Jobcanフロー（`app/flows/jobcan.py`）

- **成功判定の厳格化**: 複数セレクタのOR条件で判定
- **矛盾ログ抑止**: 例外発生時は成功ログを出さない
- **デバッグ情報保存**: 失敗時にスクショ/HTMLを `logs/` に保存
- **メモリガード**: 主要ステップ前後にメモリ監視

## 環境変数設定

`.env` ファイルに以下を追加（無ければデフォルト使用）:

```bash
NAV_TIMEOUT_MS=90000
STEP_TIMEOUT_MS=60000
BROWSER_CONCURRENCY=1
MAX_MEM_MB=450
```

## 起動コマンド（推奨）

```bash
gunicorn app.main:app -k uvicorn.workers.UvicornWorker \
  --workers 1 --threads 2 \
  --timeout 180 --max-requests 200 --max-requests-jitter 50
```

## 段階的移行計画

### Phase 1: 基本テスト（完了）
- [x] 共通ユーティリティの作成
- [x] 同時実行制御の実装
- [x] Jobcanフローの基本実装
- [x] テストファイルの作成

### Phase 2: 既存コードとの統合
- [ ] 既存の `automation.py` との互換性確認
- [ ] 段階的な非同期化
- [ ] エラーハンドリングの統一

### Phase 3: 本格運用
- [ ] 既存フローの置き換え
- [ ] パフォーマンステスト
- [ ] 監視・ログの改善

## 受け入れ条件（必須）

- [ ] 低速回線・混雑時でもログイン→出勤簿表示がタイムアウトせず完了（最大90s待機）
- [ ] 失敗時は自動再試行（最大3回）し、それでもダメならスクショ/HTMLが `logs/` に保存される
- [ ] 成功ログは成功時のみ出る。Timeout 発生時に「✅成功」と出ない
- [ ] 実行のたびに page/context/browser が確実に close され、RSS が右肩上がりにならない
- [ ] 同時実行 2 件で直列実行され、2件目は「待機中」ログの後に正常完了

## 簡易テスト方法

### 1. 基本テスト
```bash
python test_browser_utils.py
```

### 2. 通常ケース
- 今のファイルで E2E。ログに `mem(start→fill_login→timesheet ready)` が出る

### 3. 低速ケース
- ネットワークを意図的に遅くしても完走（or リトライで完走）

### 4. 異常ケース
- あえて selector を外して失敗→スクショ/HTML保存を確認

### 5. 並列テスト
- 2ユーザー同時実行→直列で順に完了、OOM/Timeout なし

## 技術的詳細

### メモリ管理
- `psutil` による RSS 監視
- 450MB 超過時に自動例外発生
- ブラウザ終了時の確実なガベージコレクション

### タイムアウト制御
- ナビゲーション: 90秒
- ステップ処理: 60秒
- セレクタ待機: 60秒

### セレクタ戦略
- **ログイン成功**: `["text=出勤簿", "#timesheet", "text=ログアウト", ".logout-button"]`
- **出勤簿確認**: `["#timesheet", "text=出勤簿", "text=勤怠入力", "input[name='date']"]`

### エラーハンドリング
- 例外発生時は必ずデバッグ情報を保存
- 成功フラグが True になった時だけ成功ログを出力
- タイムアウトとログイン失敗を明確に区別

## 注意事項

- 既存の `automation.py` は同期API、新システムは非同期API
- 段階的な移行が必要
- テスト環境での十分な検証を推奨
- 本番環境での適用は慎重に行う

## 次のステップ

1. **テスト実行**: `python test_browser_utils.py`
2. **既存コード分析**: `automation.py` の構造理解
3. **統合計画策定**: 段階的移行の詳細設計
4. **実装**: 既存フローの新システムへの移行
